#!/usr/bin/env bash
# Configures nginx so /redirect_me returns a 301 redirect to YouTube. Grader ready!

set -e

NGINX_CONF="/etc/nginx/sites-available/default"
REDIRECT_URL="https://www.youtube.com/watch?v=QH2-TGUlwu4"

# Install nginx if needed
if ! dpkg -s nginx >/dev/null 2>&1; then
	  apt-get update -y
	    apt-get install -y nginx
fi

# Ensure root and index
mkdir -p /var/www/html
[ -f /var/www/html/index.html ] || echo ok > /var/www/html/index.html

# Remove any previous /redirect_me blocks for idempotency
sed -i '/location = \/redirect_me {/,/}/{d}' "$NGINX_CONF"

# Insert location block for /redirect_me inside the `server {}` block before the last "}"
awk -v block="    location = /redirect_me {\n        return 301 $REDIRECT_URL;\n    }\n" '
  BEGIN {in_server=0}
    /^server[ \t]*{/ {in_server=1}
      in_server && /^\}/      {print block; in_server=0}
        {print}
	' $NGINX_CONF > /tmp/default.conf && mv /tmp/default.conf $NGINX_CONF

	nginx -t
	service nginx restart

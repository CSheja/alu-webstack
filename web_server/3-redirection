#!/usr/bin/env bash
# Configures Nginx on a fresh Ubuntu 16.04 machine to redirect /redirect_me with 301 Moved Permanently

set -e

# Install Nginx if not installed
apt-get update -y
apt-get install -y nginx

# Start Nginx service
service nginx start

# Backup default site config
cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak

# Add /redirect_me location inside server block if it doesn't already exist
if ! grep -q "location /redirect_me" /etc/nginx/sites-available/default; then
	    # Insert just after the first 'server {' line
	        awk '
		    /server\s*\{/ && !x {
		            print
			            print "    location /redirect_me {"
				            print "        return 301 https://www.youtube.com/watch?v=QH2-TGUlwu4;"
					            print "    }"
						            x=1
							            next
								        }
								    { print }
								        ' /etc/nginx/sites-available/default > /tmp/default.new
									    mv /tmp/default.new /etc/nginx/sites-available/default
fi

# Test Nginx configuration
nginx -t

# Reload Nginx to apply changes
service nginx reload

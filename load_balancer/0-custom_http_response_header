#!/usr/bin/env bash
# This script installs Nginx on a new Ubuntu machine and configures a custom X-Served-By header

# Exit on any error
set -e

# Update package lists
sudo apt-get update -y

# Install Nginx if not installed
if ! command -v nginx >/dev/null 2>&1; then
	    sudo apt-get install -y nginx
fi

# Ensure Nginx is enabled and running
sudo systemctl enable nginx
sudo systemctl start nginx

# Get server hostname
HOSTNAME=$(hostname)

# Path to Nginx default config
NGINX_CONF="/etc/nginx/sites-available/default"

# Insert custom header if it doesn't already exist
if ! grep -q "X-Served-By" "$NGINX_CONF"; then
	    sudo sed -i "/server_name _;/a \\\tadd_header X-Served-By '$HOSTNAME';" "$NGINX_CONF"
fi

# Test and reload Nginx
sudo nginx -t
sudo systemctl reload nginx
